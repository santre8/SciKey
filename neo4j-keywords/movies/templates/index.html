<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://neo4j-documentation.github.io/developer-resources/language-guides/assets/css/main.css">
  <title>SciKey Explorer</title>

  <style>

    /* Move search bar lower and center-left */
    .navbar-search-container {
        margin-top: 25px !important;
        display: flex;
        justify-content: flex-start;
        padding-left: 0 !important;   
    }

    .panel-heading {
        margin-bottom: 15px !important;
    }

    .container .row {
        align-items: flex-start;
    }

    .navbar-form {
        margin-left: 0 !important;
        padding-left: 0 !important;
    }

    #search {
        display: flex !important;
        gap: 10px;
        justify-content: flex-start !important; /* Move to the left */
        width: 100%; /* Let it span full width */
    }

    #search input[type="text"] {
        width: 350px !important; /* Bigger search box */
    }

    /* Make the input wider */
    #search .form-control {
      width: 100%;
      min-width: 400px;              /* tamaño mínimo del cuadro de búsqueda */
    }

    /* Hide relationship labels on links */
    .link text, 
    text.link, 
    .link-label, 
    edge, 
    path text {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }

    .results-panel {
      max-height: 820px;
      overflow-y: auto;
    }

    #graph {
      height: 760px;
      margin: 140px 0 0 0;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 4px;
    }

    .col-md-7 .panel-body {
        padding-left: 0 !important;
        padding-right: 0 !important;
    }

    .link {
      stroke: #aaa;
      stroke-opacity: .7;
      stroke-width: 1.5px;
    }

    .node {
      stroke: #222;
      stroke-width: 1.5px;
    }

    .node.Document { fill: #6baed6; }
    .node.Keyword  { fill: #74c476; }
    .node.Item     { fill: #fd8d3c; }
    .node.Class    { fill: #9e9ac8; }

    .node:hover {
      stroke-width: 2.5px;
    }

    .arrow-head {
      fill: #aaa;
    }

    .node-label {
      font-size: 11px;
      fill: #555;
      pointer-events: none;
    }

    .graph-legend {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 13px;
      align-items: center;
    }

    .graph-legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid #222;
    }

    .legend-document { background: #6baed6; }
    .legend-keyword  { background: #74c476; }
    .legend-item     { background: #fd8d3c; }
    .legend-class    { background: #9e9ac8; }

    /* Document details panel */
    #doc-details .meta-label {
      font-weight: 600;
    }

    .kw-chip {
      display: inline-block;
      margin: 3px 4px;
      padding: 4px 8px;
      border-radius: 12px;
      border: 1px solid #337ab7;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }

    .kw-chip:hover {
      background: #337ab7;
      color: white;
    }

  </style>
</head>

<body>

  <!-- NAVBAR -->
  <div role="navigation" class="navbar navbar-default navbar-static-top">
    <div class="container">
      <div class="row">

        <!-- Search bar on the left -->
        <div class="col-sm-6 col-md-6 navbar-search-container">
        <form role="search" class="navbar-form" id="search">
            <div class="form-group">
            <input type="text" placeholder="Search the keyword" class="form-control" name="search">
            </div>
            <button class="btn btn-default" type="submit">Search</button>
        </form>
        </div>


        <!-- SciKey logo + tagline on the right (click to go home) -->
        <div class="navbar-header col-sm-6 col-md-6" style="text-align:center;">

          <a href="/" style="text-decoration:none; display:inline-block; padding-top:5px; padding-bottom:5px;">
            <img src="{% static 'scikey-logo.png' %}"
                 alt="SciKey Logo"
                 style="height:80px; display:block; margin:0 auto;">

            <div style="
              font-size:18px;
              margin-top:4px;
              letter-spacing:0.25em;
              text-transform:uppercase;
              color:#c9b27b;
              font-weight:600;">
              SEARCH FOR KNOWLEDGE
            </div>
          </a>

        </div>

      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="row">

    <!-- LEFT PANEL: search results + document details -->
    <div class="col-md-5">
      <div class="panel panel-default results-panel">
        <div class="panel-heading">Search Results</div>

        <table id="results" class="table table-striped table-hover">
          <thead>
            <tr>
              <th>DOCID</th>
              <th>Title</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- Document details panel -->
        <div id="doc-details" class="panel panel-default" style="margin: 15px;">
          <div class="panel-heading">Document details</div>
          <div class="panel-body">
            <p>Select a document in the table above.</p>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT PANEL: graph -->
    <div class="col-md-7">
      <div class="panel panel-default">
        <div class="panel-heading" id="title">Details</div>
        <div class="panel-body">

          <div class="graph-legend">
            <div class="graph-legend-item">
              <span class="legend-color legend-document"></span> Document
            </div>
            <div class="graph-legend-item">
              <span class="legend-color legend-keyword"></span> Keyword
            </div>
            <div class="graph-legend-item">
              <span class="legend-color legend-item"></span> Wikidata Item
            </div>
            <div class="graph-legend-item">
              <span class="legend-color legend-class"></span> Wikidata Class
            </div>
          </div>

          <div id="graph"></div>

        </div>
      </div>
    </div>

  </div>

  <!-- SCRIPTS -->
  <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
  <script src="https://d3js.org/d3.v3.min.js"></script>

  <script>
    /**************************************************
     * FUNCTION: render graph
     **************************************************/
    function renderGraph(docid, keyword) {
      d3.select("#graph").selectAll("svg").remove();

      var width = 800, height = 800;

      var force = d3.layout.force()
        .charge(-350)
        .linkDistance(80)
        .gravity(0.08)
        .size([width, height]);

      var svg = d3.select("#graph").append("svg")
        .attr("width", width)
        .attr("height", height);

      var defs = svg.append("defs");
      defs.append("marker")
        .attr("id", "arrow")
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 16)
        .attr("refY", 0)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("path")
        .attr("d", "M0,-5L10,0L0,5")
        .attr("class", "arrow-head");

      let url = "/graph?docid=" + encodeURIComponent(docid);
      if (keyword) url += "&kw=" + encodeURIComponent(keyword);

      d3.json(url, function(error, graph) {
        if (error) return;
        if (!graph.nodes || graph.nodes.length === 0) return;

        var indexById = {};
        graph.nodes.forEach(function(n, i) { indexById[n.id] = i; });

        graph.links = graph.links.map(function(l) {
          return {
            source: indexById[l.source],
            target: indexById[l.target],
            type: l.type
          };
        });

        force.nodes(graph.nodes).links(graph.links).start();

        var link = svg.append("g").selectAll(".link")
          .data(graph.links)
          .enter().append("line")
          .attr("class", "link")
          .attr("marker-end", "url(#arrow)");

        var node = svg.append("g").selectAll(".node")
          .data(graph.nodes)
          .enter().append("circle")
          .attr("class", function(d) { return "node " + d.label; })
          .attr("r", 12)
          .call(force.drag);

        node.append("title")
          .text(function(d) { return d.title || d.caption || d.id; });

        var nodeLabel = svg.append("g").selectAll(".node-label")
          .data(graph.nodes)
          .enter().append("text")
          .attr("class", "node-label")
          .attr("dy", -14)
          .text(function(d) {
            if (["Item", "Class", "Keyword"].includes(d.label))
              return (d.caption || d.title || "").slice(0, 18);
            return "";
          });

        force.on("tick", function() {
          link.attr("x1", d => d.source.x)
              .attr("y1", d => d.source.y)
              .attr("x2", d => d.target.x)
              .attr("y2", d => d.target.y);

          node.attr("cx", d => d.x)
              .attr("cy", d => d.y);

          nodeLabel.attr("x", d => d.x)
                   .attr("y", d => d.y);
        });

      });
    }

    /**************************************************
     * FUNCTION: load document metadata
     **************************************************/
    function loadDocDetails(docid) {
      $.get("/doc-details?docid=" + encodeURIComponent(docid), function(data) {
        var $panel = $("#doc-details .panel-body");

        if (!data || data.error) {
          $panel.html("<p>No metadata found for this document.</p>");
          return;
        }

        var html = "";

        if (data.title) {
          html += "<p><span class='meta-label'>Title:</span><br>" +
                  $('<div>').text(data.title).html() + "</p>";
        }

        if (data.authors && data.authors.length) {
          html += "<p><span class='meta-label'>Authors:</span><br>" +
                  data.authors.join(", ") + "</p>";
        }

        if (data.journal && (data.journal.title || data.journal.issn)) {
          html += "<p><span class='meta-label'>Journal:</span><br>";
          if (data.journal.title) html += data.journal.title;
          if (data.journal.issn) html += " <small>(ISSN " + data.journal.issn + ")</small>";
          html += "</p>";
        }

        if (data.organisms && data.organisms.length) {
          html += "<p><span class='meta-label'>Organisms:</span><br>" +
                  data.organisms.join(", ") + "</p>";
        }

        if (data.keywords && data.keywords.length) {
          html += "<p><span class='meta-label'>Keywords:</span><br>";
          data.keywords.forEach(function(kw) {
            var safeKw = $('<div>').text(kw).html();
            html += `<span class="kw-chip" data-kw="${safeKw}">${safeKw}</span>`;
          });
          html += "</p>";
        }

        if (data.url_primary) {
          html += `<p><a href="${data.url_primary}" target="_blank">Open in HAL</a></p>`;
        }

        $panel.html(html);

        // When clicking a keyword, reuse it as search term
        $("#doc-details .kw-chip").off("click").on("click", function () {
          var kw = $(this).data("kw");
          $("#search").find("input[name=search]").val(kw);
          $("#search").submit();
        });

      }, "json");
    }

    /**************************************************
     * SEARCH FUNCTION
     **************************************************/
    $(function () {

      function search() {
        var q = $("#search").find("input[name=search]").val();

        $.get("/search?q=" + encodeURIComponent(q), function (data) {
          var t = $("table#results tbody").empty();

          if (!data || data.length === 0) {
            $("#title").text("No results");
            d3.select("#graph").selectAll("svg").remove();
            return;
          }

          data.forEach(function (row, idx) {
            var safeTitle = row.title || "";

            var $tr = $(`
              <tr>
                <td class="docid">${row.id}</td>
                <td class="doctitle">${safeTitle}</td>
              </tr>`);

            $tr.appendTo(t).click(function () {
              var docid = $(this).find("td.docid").text();
              var title = $(this).find("td.doctitle").text();

              $("#title").text("Details: " + (title || docid));
              renderGraph(docid);
              loadDocDetails(docid);
            });

            if (idx === 0) {
              $("#title").text("Details: " + (safeTitle || row.id));
              renderGraph(row.id);
              loadDocDetails(row.id);
            }
          });

        }, "json");

        return false;
      }

      $("#search").submit(search);

      var params = new URLSearchParams(window.location.search);
      var initialQ = params.get("q");
      if (initialQ) {
        $("#search").find("input[name=search]").val(initialQ);
      }

      search();
    });

  </script>

</body>
</html>
