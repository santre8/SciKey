<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://neo4j-documentation.github.io/developer-resources/language-guides/assets/css/main.css">
  <title>Neo4j Movies carmen</title>
  <style>
    /* Panel izquierdo con scroll para resultados largos */
    .results-panel { max-height: 820px; overflow-y: auto; }

    /* Contenedor del grafo */
    #graph {
      height: 820px;           /* espacio visible para el SVG */
      margin: 0;
      background: #fff;
      position: relative;
      z-index: 1;
      border: 1px solid #eee;
      border-radius: 4px;
    }

    /* Estilos D3 */
    .node { stroke: #222; stroke-width: 1.5px; }
    .link { stroke: #999; stroke-opacity: .6; stroke-width: 1px; }

    /* Colores por tipo de nodo */
    .node.Document { fill: #6baed6; }
    .node.Keyword  { fill: #74c476; }
    .node.Item     { fill: #fd8d3c; }
    .node.Class    { fill: #9e9ac8; }
  </style>
</head>

<body>
  <div role="navigation" class="navbar navbar-default navbar-static-top">
    <div class="container">
      <div class="row">
        <div class="col-sm-6 col-md-6">
          <ul class="nav navbar-nav">
            <li>
              <form role="search" class="navbar-form" id="search">
                <div class="form-group">
                  <input type="text" value="" placeholder="Search for Movie Title" class="form-control" name="search">
                </div>
                <button class="btn btn-default" type="submit">Search</button>
              </form>
            </li>
          </ul>
        </div>
        <div class="navbar-header col-sm-6 col-md-6">
          <div class="logo-well">
            <a href="https://neo4j.com/developer/get-started">
              <img src="https://neo4j-documentation.github.io/developer-resources/language-guides/assets/img/logo-white.svg" alt="Neo4j World's Leading Graph Database" id="logo">
            </a>
          </div>
          <div class="navbar-brand">
            <div class="brand">Neo4j Movies</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Panel izquierdo: búsqueda/lista -->
    <div class="col-md-5">
      <div class="panel panel-default results-panel">
        <div class="panel-heading">Search Results</div>
        <table id="results" class="table table-striped table-hover">
          <thead>
            <tr>
              <th>DOCID</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Panel derecho: grafo -->
    <div class="col-md-7">
      <div class="panel panel-default">
        <div class="panel-heading" id="title">Details</div>
        <div class="panel-body">
          <div id="graph"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="//code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script>
  <script src="https://d3js.org/d3.v3.min.js" type="text/javascript"></script>

  <script type="text/javascript">
    // --- Render del grafo para un docid ---
    function renderGraph(docid) {
      // Limpia grafo previo
      d3.select("#graph").selectAll("svg").remove();

      const width = 800, height = 800;

      const force = d3.layout.force()
        .charge(-200).linkDistance(30).size([width, height]);

      const svg = d3.select("#graph").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("pointer-events", "all");

      d3.json("/graph?docid=" + encodeURIComponent(docid), function(error, graph) {
        if (error) { console.error(error); return; }
        if (!graph || !graph.nodes || graph.nodes.length === 0) { console.warn("No nodes"); return; }

        // D3 v3 requiere índices en source/target
        var indexById = {};
        graph.nodes.forEach(function(n, i) { indexById[n.id] = i; });
        graph.links = graph.links.map(function(l) {
          return { source: indexById[l.source], target: indexById[l.target], type: l.type };
        });

        force.nodes(graph.nodes).links(graph.links).start();

        var link = svg.selectAll(".link")
          .data(graph.links).enter()
          .append("line").attr("class", "link");

        var node = svg.selectAll(".node")
          .data(graph.nodes).enter()
          .append("circle")
          .attr("class", function (d) { return "node " + d.label; })
          .attr("r", 10)
          .call(force.drag);

        node.append("title")
          .text(function (d) { return d.title || d.caption || d.id; });

        force.on("tick", function() {
          link.attr("x1", function(d) { return d.source.x; })
              .attr("y1", function(d) { return d.source.y; })
              .attr("x2", function(d) { return d.target.x; })
              .attr("y2", function(d) { return d.target.y; });

          node.attr("cx", function(d) { return d.x; })
              .attr("cy", function(d) { return d.y; });
        });
      });
    }

    // --- Búsqueda y selección de DOCID ---
    $(function () {
      function search() {
        const query = $("#search").find("input[name=search]").val();
        $.get("/search?q=" + encodeURIComponent(query), function (data) {
          const t = $("table#results tbody").empty();
          if (!data || data.length === 0) return;

          data.forEach(function (row, idx) {
            $("<tr><td class='docid'>" + row.id + "</td></tr>")
              .appendTo(t)
              .click(function () {
                const docid = $(this).find("td.docid").text();
                $("#title").text("Details: " + docid);
                renderGraph(docid);
              });

            // Render del primero automáticamente
            if (idx === 0) {
              $("#title").text("Details: " + row.id);
              renderGraph(row.id);
            }
          });
        }, "json");
        return false;
      }

      $("#search").submit(search);
      search(); // primera carga
    });
  </script>
</body>
</html>
